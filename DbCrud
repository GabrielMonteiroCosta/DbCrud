
using System;
using System.Data.SqlClient;
using System.Runtime.CompilerServices;

internal class Program
{
    const string connectionString = "Server=DESKTOP-UFKML55;Database=Boliche1;User Id=sa;Password=Vector5**;";
    private static void Main(string[] args)
    {
        List<Cliente> clientes = new();
        List<Produto> produtos = new();
        tabelaPreco();
        CreateProduct(produtos);
        //validaParticipantes();
        //CadastrarCliente(clientes);
    }
    static void tabelaPreco()
    {
        DateTime horaAtual = DateTime.Now;
        Console.WriteLine("\n|-----------------------|\n|Bem-Vindo ao Gaboliche!|\n|-----------------------|");
        Console.WriteLine("\n***Veja a nossa tabela de preços de Segunda até Quinta-Feira***");
        Console.WriteLine("\n|-----------------------------|" +
            "\n|12h00 até às 17h00 = R$100,00|" +
            "\n|17h00 até às 22h00 = R$120,00|");
        Console.WriteLine("|-----------------------------|");
        Console.WriteLine("\nVALOR FIXO NO TÊNIS E MEIAS: R$10,00");

        Console.WriteLine("\n***Veja a nossa tabela de preços de Sexta à Domingo (Vésperas e Feriados)***");
        Console.WriteLine("\n|-----------------------------|" +
            "\n|12h00 até às 17h00 = R$110,00|" +
            "\n|17h00 até às 22h00 = R$130,00|");
        Console.WriteLine("|-----------------------------|");
        Console.WriteLine("\nVALOR FIXO NO TÊNIS E MEIAS: R$10,00");
    }
    static void validaParticipantes()
    {
        Console.Write("\nPor favor insira quantas pessoas vão participar (MÁX 6 PESSOAS):");
        while (true)
        {
            if (int.TryParse(Console.ReadLine(), out int participantes))
            {
                if (participantes <= 5 && participantes > 0)
                {
                    Console.WriteLine($"Separando equipamento para {participantes} pessoas, deseja fazer o nosso cadastro Gaboliche-Fã?\n" +
                        "Usuários cadastrados no nosso sistema ganham 15% de desconto na sexta vez que vem aqui!");
                    break;
                }
                if (participantes > 6)
                {
                    Console.WriteLine("Mais do que 6(Seis) pessoas não são suportadas, o limite são 6 Pistas!");
                    Console.WriteLine($"Você quer entrar com 6 pessoas, lembrando que os outros {participantes - 6} participantes entraram em uma fila de espera. ");
                    Console.WriteLine("Continuar com 6 participantes(S/N): ");
                    string continuaComFila = Console.ReadLine();
                    if ("s".Equals(continuaComFila, StringComparison.OrdinalIgnoreCase))
                    {
                        Console.WriteLine("Continuando com 6 pessoas!");
                        continue;
                    }
                    if ("n".Equals(continuaComFila, StringComparison.OrdinalIgnoreCase))
                    {
                        Console.Write("Ok, muito obrigado pela compreensão!");
                        return;
                    }


                }
                if (participantes == 6)
                {
                    Console.WriteLine("Separando equipamento para 6 pessoas, 5% de desconto aplicado para cada um no valor final!");
                    break;
                }
            }
        }
    }
    static void CadastrarCliente(List<Cliente> clientes)
    {
        Cliente cliente = new();
        try
        {
            cliente.CPF = CreateCPF();
        }
        catch
        {
            return;
        }
        Console.Write("Insira o Nome do Player: ");
        cliente.Nome = Console.ReadLine();
        Console.Write("Insira o telefone do cliente (DDD): ");
        cliente.Telefone = Console.ReadLine();
        cliente.Historico += 1;

        using (SqlConnection connect = new(connectionString))
        {
            connect.Open();
            int proximoId;
            using (SqlCommand cmdNextId = new("SELECT ISNULL(MAX(id), 0) + 1 FROM Clientes", connect))
            {
                proximoId = (int)cmdNextId.ExecuteScalar();
            }
            string query = @"
                insert into Clientes
                (
                	Id, Nome, CPF, Status, Telefone, Historico
                )
                values 
                (
                	@id, @nome, @CPF, 1, @telefone, @historico
                )";
            using (SqlCommand command = new(query, connect))
            {
                command.Parameters.AddWithValue("@id", proximoId);
                command.Parameters.AddWithValue("@nome", cliente.Nome);
                command.Parameters.AddWithValue("@CPF", cliente.CPF);
                command.Parameters.AddWithValue("@historico", cliente.Historico);
                command.Parameters.AddWithValue("@telefone", string.IsNullOrEmpty(cliente.Telefone) ? DBNull.Value : cliente.Telefone);

                command.ExecuteNonQuery();
                Console.WriteLine("Usuário cadastrado com sucesso.");
                connect.Close();
            }
        }
    }
    static void CreateProduct(List<Produto> produtos)
    {
        Produto produto = new Produto();
        Console.Write("Insira a descrição do Produto: ");
        produto.Descricao = Console.ReadLine();
        Console.WriteLine("Insira a Quantidade que há em estoque desse produto: ");
        if(int.TryParse(Console.ReadLine(), out int qtdAtual))
        {
            produto.Quantidade = qtdAtual;
        }
        else
        {
            Console.WriteLine("Insira uma quantidade válida para o produto!");
        }
        Console.WriteLine("Insira o Preço de Venda desse produto: ");
        if (double.TryParse(Console.ReadLine(), out double precoVenda))
        {
            produto.PrecoVenda = precoVenda;
        }
        else
        {
            Console.WriteLine("Insira um Preço em R$ para o produto!");
        }

        using(SqlConnection connection = new(connectionString))
        {
            connection.Open();
            int proximoId;
            using (SqlCommand cmdNextId = new("SELECT ISNULL(MAX(idItem), 0) + 1 FROM Produtos", connection))
            {
                proximoId = (int)cmdNextId.ExecuteScalar();
            }
            string query = @"insert into Produtos
                (
                	idItem, descricao, quantidade, precoVenda
                )
                values 
                ( 
                    @idItem, @descricao, @quantidade, @precoVenda
                );";
            using(SqlCommand command = new SqlCommand(query, connection))
            {
                command.Parameters.AddWithValue("@idItem", proximoId);
                command.Parameters.AddWithValue("@descricao", produto.Descricao);
                command.Parameters.AddWithValue("@quantidade", produto.Quantidade);
                command.Parameters.AddWithValue("@precoVenda", produto.PrecoVenda);

                command.ExecuteNonQuery();
                Console.WriteLine("Produto cadastrado com sucesso.");
                connection.Close();


            }
        }
    }
    public static string? CreateCPF()
    {
        static string? ValidaCPF()
        {
            Console.WriteLine("Digite o CPF: ");
            string? validar = Console.ReadLine();
            if (!Equals(validar?.Length, 11))
            {
                Console.WriteLine("Não foi possível registrar esse CPF, parece que há menos números do que deveria!");
                ValidaCPF();
            }
            return validar;
        }

        string? cpf = ValidaCPF();
        using (SqlConnection connect = new(connectionString))
        {
            connect.Open();
            using (SqlCommand command = connect.CreateCommand())
            {
                command.CommandText = $"Select count(CPF) from Clientes where CPF = @CPF";
                command.Parameters.AddWithValue("CPF", string.IsNullOrEmpty(cpf) ? DBNull.Value : cpf);
                var obj = (int)command.ExecuteScalar();
                connect.Close();
                if (obj > 0)
                {
                    throw new Exception("Esse número de CPF já existe cadastrado no Gaboliche!");
                }
                return cpf;
            }
        }
    }


    public class Cliente
    {
        public int Id { get; set; }
        public string? Nome { get; set; }
        public string CPF { get; set; }
        public string? Telefone { get; set; }
        public int Status { get; set; }
        public int Historico { get; set; }
    }

    public class Produto
    {
        public int IdItem { get; set; }
        public string Descricao { get; set; }
        public int Quantidade { get; set; }
        public double PrecoVenda { get; set; }
    }
    public class Cardapio : Produto
    {
        public string Categoria { get; set; }
    }
}
